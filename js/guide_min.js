$(function(){var script;var pointer = 0;var command = null;var instr = null;var message = null;var interval = 0;var seladd = [];var timer = 0;var address = [];var variable = [];var retina = (window.devicePixelRatio > 1)?true:false;var random = Math.floor(Math.random() * 4);var girl_name = ["明日香", "美咲", "真白", "莉佳"];variable["name"] = girl_name[random];$.getJSON("js/script.json", function(data){script = data;scan_script();$("#chara").addClass("chara" + random);$("#title").fadeIn();$("#title").click(function(){$(this).unbind();$(this).fadeOut("slow", function(){$("#bg").fadeIn("slow", function(){$("#chara").fadeIn(function(){$("#text").fadeIn(start_game_loop);});});});});});$("#interact").click(interact);function scan_script(){for(var i=0; i<script.length; i++){var instr = script[i][0];if(instr.substr(instr.length-1,1) == ":"){var label = instr.substr(0, instr.length-1);address[label] = i;}}}function is_pointer_valid(){return pointer >= 0 && pointer < script.length;}function get_next_command(){return script[pointer++];}function command_finish(){command = null;instr = null;}function start_game_loop(){timer = window.setInterval(game_loop, 1.0/15);console.log("game start");}function exit_game_loop(){window.clearInterval(timer);console.log("game end");}function game_loop(){if(command != null)  return;if(is_pointer_valid){command = get_next_command();}else{exit_game_loop();}instr = command[0];var param1 = command[1];var param2 = command[2];var param3 = command[3];if(instr == "text"){instr_text(param1, param2);}else if(instr == "seladd"){instr_seladd(param1, param2);}else if(instr == "select"){instr_select();}else if(instr == "set"){instr_set(param1, param2);}else if(instr == "goto"){instr_goto(param1);}else if(instr == "exit"){instr_exit();}else if(instr == "openurl"){instr_openurl(param1);}else if(instr == "image"){instr_image(param1, param2, param3);}else{if (instr.substr(instr.length-1, 1) == ":"){command_finish();}console.log("invalid instr:", instr);}}function instr_text(msg, name){$("#text").text("");if(name != "")      show_name(name);else    hide_name();message = escape_variable(decodeURIComponent(msg));interval = window.setInterval(show_message, 50);}function show_message(){var cur_msg = $("#text").text();if(cur_msg.length < message.length){var new_msg = message.substr(0, cur_msg.length + 1);$("#text").text(new_msg);}else{window.clearInterval(interval);show_icon();}}function show_all_message(){window.clearInterval(interval);$("#text").text(message);show_icon();}function show_icon(){interval = window.setInterval(icon_blink, 500);}function icon_blink(){var cur_msg = $("#text").text();if(cur_msg.length == message.length){$("#text").text(message + "▼");}else{$("#text").text(message);}}function message_finish(){window.clearInterval(interval);$("#text").text(message);command_finish();}function interact(){if(instr == "text"){var cur_msg = $("#text").text();if(cur_msg.length < message.length)     show_all_message();else    message_finish();}else if(instr == "image"){hide_image();}}function show_name(name){$("#name").text(escape_variable(name));$("#name").show();}function hide_name(){$("#name").text("");$("#name").hide();}function escape_variable(text){for(key in variable){text = text.replace("<" + key + ">", variable[key]);}return text;}function instr_seladd(text, label){seladd.push([decodeURIComponent(text), label]);command_finish();}function instr_select(){$("#select").empty();for(var i=0; i<seladd.length; i++){var label = seladd[i][0];var target = seladd[i][1];$("#select").append("<li target=\"" + target + "\">" + label.replace(/\\n/g, "<br/>") + "</li>");}$("#select li").click(user_select);select_layout();$("#mask").fadeIn();$("#select").fadeIn();}function select_layout(){n = $("#select li").length;if(n == 5){$("#select li").width("600px").css("margin", "20px auto");}height = $("#select").height();$("#select").css("marginTop", Math.floor((420-height)/2)+"px");}function user_select(){var target = $(this).attr("target");$("#mask").fadeOut();$("#select").fadeOut(function(){if(target != "")  set_pointer(target);seladd = [];command_finish();});}function instr_image(src, width, height){img_left = Math.floor((800 - width) / 2);img_top = Math.floor((410 - height) / 2);if(retina)  src = src.replace(".jpg", "@2x.jpg");$("#image").append("<img src=\"img/guide/images/"+src+"\" width=\""+width+"\" height=\""+height+"\" />");$("#image").css({"width": width+"px", "height": height+"px", "left": img_left+"px", "top": img_top+"px" });$("#mask").fadeIn();$("#image").fadeIn();}function hide_image(){$("#mask").fadeOut();$("#image").fadeOut(function(){$("#image").empty();command_finish();});}function instr_label(){command_finish();}function instr_goto(label){set_pointer(label);command_finish();}function set_pointer(label){pointer = address[label];if(!is_pointer_valid()){console.log("invalid pointer:", pointer);exit_game_loop();}}function instr_set(key, value){variable[key] = value;command_finish();}function instr_openurl(url){window.location = url;}function instr_exit(){exit_game_loop();}var bgm = false;$("#bgm_btn").click(function(){if(bgm){bgm = false;$(this).removeClass("on").addClass("off");$("#bgm_player").get(0).pause();}else{bgm = true;$(this).removeClass("off").addClass("on");$("#bgm_player").get(0).play();}});});